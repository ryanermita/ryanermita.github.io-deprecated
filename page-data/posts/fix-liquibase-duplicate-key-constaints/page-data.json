{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/fix-liquibase-duplicate-key-constaints","result":{"data":{"markdownRemark":{"id":"b29af7b8-efd7-5293-9625-771db3628733","html":"<p>During the production deployment of one of our services, we encountered a database error when running our <a href=\"https://www.liquibase.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">liquibase</a> migration. As additional information, the service that we’re trying to deploy already have an initial set of data. The error we encountered is this:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ERROR:  duplicate key violates unique constraint</code></pre></div>\n<p>This error happens because liquibase assumes that we’re migrating a fresh set of data, so it starts the primary key sequence at 1. <a href=\"https://stackoverflow.com/a/21639138\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">This can be solved by setting the primary key sequence at the right location</a>. Which can be done by running this query on your database console.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> setval<span class=\"token punctuation\">(</span><span class=\"token string\">'primary_id_seq'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> <span class=\"token function\">MAX</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> <span class=\"token keyword\">table</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This will set the primary key sequence to the next sequence which will prevent the error that we encountered. Ideally, when migrating with <a href=\"https://www.liquibase.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Liquibase</a> on a services that has initial data, we should include the update key sequence query on our migration script.</p>","fields":{"slug":"/posts/fix-liquibase-duplicate-key-constaints","tagSlugs":["/tag/liquibase/","/tag/database-constraints/","/tag/databases/"]},"frontmatter":{"date":"2020-04-21","description":"Got stuck on a problem during our deployment. The issue was about the database constraint exception that was raised by the Database (Postgre) - duplicate key constraint. This article will discuss how we solved the issue.","tags":["liquibase","database constraints","databases"],"title":"Fix Liquibase Duplicate Key Constraints","socialImage":null}}},"pageContext":{"slug":"/posts/fix-liquibase-duplicate-key-constaints"}},"staticQueryHashes":["251939775","3872291177","401334301"]}